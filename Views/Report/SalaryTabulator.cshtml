@* @{
    ViewData["Title"] = "Salary Summary (Tabulator)";
    var departments = ViewBag.Departments as List<HrManagement.Models.Department>;
}

<h2>Salary Report</h2>

<div class="row mb-3">
    <div class="col-md-3">
        <select id="deptFilter" class="form-select">
            <option value="">-- Department --</option>
            @foreach (var dept in departments)
            {
                <option value="@dept.DeptId">@dept.DeptName</option>
            }
        </select>
    </div>
    <div class="col-md-2">
        <select id="yearFilter" class="form-select">
            @for (int y = DateTime.Now.Year - 5; y <= DateTime.Now.Year + 1; y++)
            {
                <option value="@y" selected="@(y == DateTime.Now.Year ? "selected" : null)">@y</option>
            }
        </select>
    </div>
    <div class="col-md-2">
        <select id="monthFilter" class="form-select">
            @for (int m = 1; m <= 12; m++)
            {
                <option value="@m" selected="@(m == DateTime.Now.Month ? "selected" : null)">
                    @System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(m)
                </option>
            }
        </select>
    </div>
    <div class="col-md-2">
        <select id="paidFilter" class="form-select">
            <option value="">All</option>
            <option value="true">Paid</option>
            <option value="false">Unpaid</option>
        </select>
    </div>
    <div class="col-md-3">
        <button id="filterBtn" class="btn btn-primary w-100">Filter</button>
    </div>
</div>

<div class="mb-3 text-end">
    <button class="btn btn-outline-secondary me-2" onclick="exportExcel()">Export Excel</button>
    <button class="btn btn-outline-info me-2" onclick="exportCSV()">Export CSV</button>
    <button class="btn btn-outline-danger" onclick="exportPDF()">Export PDF</button>
</div>


<div id="salary-table"></div>

<link href="https://unpkg.com/tabulator-tables@5.4.4/dist/css/tabulator.min.css" rel="stylesheet">
<script src="https://unpkg.com/tabulator-tables@5.4.4/dist/js/tabulator.min.js"></script>

<script>
    let salaryTable;

    function loadSalaryTable(params = {}) {
        salaryTable = new Tabulator("#salary-table", {
            layout: "fitColumns",
            ajaxURL: "/Report/GetSalarySummary",
            ajaxParams: params,
            pagination: "local",
            paginationSize: 10,
            height: "500px",
            columns: [
                { title: "Employee", field: "empName" },
                { title: "Gross", field: "gross", hozAlign: "right" },
                { title: "Basic", field: "basic", hozAlign: "right" },
                { title: "HRent", field: "hRent", hozAlign: "right" },
                { title: "Medical", field: "medical", hozAlign: "right" },
                { title: "Absent Amount", field: "absentAmount", hozAlign: "right" },
                { title: "Payable", field: "payableAmount", hozAlign: "right" },
                { title: "Status", field: "isPaid", hozAlign: "center" }
            ]
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        loadSalaryTable();

        document.getElementById("filterBtn").addEventListener("click", function () {
            const deptId = document.getElementById("deptFilter").value;
            const year = document.getElementById("yearFilter").value;
            const month = document.getElementById("monthFilter").value;
            const isPaid = document.getElementById("paidFilter").value;

            salaryTable.setData("/Report/GetSalarySummary", {
                deptId, year, month, isPaid
            });
        });
    });

        function exportExcel() {
        salaryTable.download("xlsx", "SalaryReport.xlsx", { sheetName: "Salaries" });
    }

    function exportCSV() {
        salaryTable.download("csv", "SalaryReport.csv");
    }

    function exportPDF() {
        salaryTable.download("pdf", "SalaryReport.pdf", {
            orientation: "portrait",
            title: "Salary Report"
        });
    }

</script>
 *@

@{
    ViewData["Title"] = "Salary Report";
}

<h2>Salary Report</h2>
<div class="row mb-3">
    <div class="col-md-3">
        <select id="ddlCompany" class="form-select"></select>
    </div>
    <div class="col-md-3">
        <select id="ddlDepartment" class="form-select"></select>
    </div>
    <div class="col-md-2">
        <input type="number" id="year" placeholder="Year" class="form-control" />
    </div>
    <div class="col-md-2">
        <input type="number" id="month" placeholder="Month" class="form-control" />
    </div>
    <div class="col-md-2">
        <select id="isPaid" class="form-select">
            <option value="">All</option>
            <option value="true">Paid</option>
            <option value="false">Unpaid</option>
        </select>
    </div>
</div>
<div class="mb-3">
    <button id="btnLoadSalary" class="btn btn-primary">Load Report</button>
    <button id="btnExportExcelSalary" class="btn btn-success">Export Excel</button>
    <button id="btnExportCSV" class="btn btn-primary">Export CSV</button>
    <button id="btnExportPDF" class="btn btn-danger">Export PDF</button>
</div>

<div id="salary-table"></div>

@section Scripts {
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/tabulator-tables@5.4.4/dist/js/tabulator.min.js"></script>

    <!-- Tabulator CSS -->
    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">

    <!-- Tabulator JS -->
    <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>



    <script>
        let salaryTable;

        $(document).ready(function () {
            loadCompanies();

            $("#ddlCompany").change(function () {
                const companyId = $(this).val();
                $.get("/Report/GetDepartmentsByCompany", { companyId }, function (data) {
                    let options = '<option value="">-- Select Department --</option>';
                    $.each(data, (i, item) => {
                        options += `<option value="${item.id}">${item.deptName}</option>`;
                    });
                    $("#ddlDepartment").html(options);
                });
            });

            $("#btnLoadSalary").click(function () {
                const params = {
                    companyId: $("#ddlCompany").val(),
                    deptId: $("#ddlDepartment").val(),
                    year: $("#year").val(),
                    month: $("#month").val(),
                    isPaid: $("#isPaid").val()
                };

                salaryTable = new Tabulator("#salary-table", {
                    ajaxURL: "/Report/GetSalaryTabulator",
                    ajaxParams: params,
                    layout: "fitColumns",
                    pagination: "local",
                    paginationSize: 10,
                    columns: [
                        { title: "Employee", field: "empName" },
                        { title: "Gross", field: "gross" },
                        { title: "Basic", field: "basic" },
                        { title: "HRent", field: "hrent" },
                        { title: "Medical", field: "medical" },
                        { title: "Absent Amount", field: "absentAmount" },
                        { title: "Payable", field: "payableAmount" },
                        { title: "Status", field: "isPaid" },
                        { title: "Department", field: "department" },
                        { title: "Designation", field: "designation" }
                    ]
                });
            });

            $("#btnExportExcelSalary").click(function () {
                if (salaryTable) salaryTable.download("xlsx", "SalaryReport.xlsx", { sheetName: "Salary" });
            });
            $("#btnExportCSV").click(function () {
                if (salaryTable) {
                    salaryTable.download("csv", "SalaryTabulator.csv");
                }
            });

            $("#btnExportPDF").click(function () {
                if (salaryTable) {
                    salaryTable.download("pdf", "SalaryTabulator.pdf", {
                        orientation: "portrait",
                        title: "Salary List"
                    });
                }
            });

            function loadCompanies() {
                $.get("/Report/GetAll", function (data) {
                    let options = '<option value="">-- Select Company --</option>';
                    $.each(data, (i, item) => {
                        options += `<option value="${item.id}">${item.compName}</option>`;
                    });
                    $("#ddlCompany").html(options);
                });
            }
        });
    </script>
}
